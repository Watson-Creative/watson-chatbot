<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watson Creative Chat</title>
    <link rel="stylesheet" href="style.css">
    <style> 
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: #022822;
            font-size: 16px;
            line-height: 100%;
        }
        body {
            background-color: #f4f2f1;
        }
    </style>
</head>
<body>
    <div class="watson-chat-popup-container">
        <div class="watson-chat-popup-content">
            <h2>Watson Creative Chat</h2>
            <p>This is a chat popup test.</p>
        </div>
    </div>
<!-- START CHAT BOT CODE -->
<style>
    [class*="allm-shadow-"] {
        box-shadow: none !important;
    }
    #watson-chat-popup {
        pointer-events: auto !important;
    }
    #watson-chat-popup::before {
        content: '';
        position: absolute;
        bottom: -7px;
        left: 11px;
        width: 14px;
        height: 14px;
        background-color: rgba(0,0,0,0.1);
        transform: rotate(45deg);
        border-radius: 0 0 2px 0;
        z-index: -1;
    }
    #anything-llm-chat {
        min-height: calc(100%-20px) !important;
        height: calc(100%-20px) !important;
        max-height: calc(100%-20px) !important;
        /*margin: 0px 0px 10px 10px;*/
    }
    .anything-llm-embed-chat-container,.allm-z-50 {
        z-index: 100000000 !important;
    }
</style>
<script
  data-embed-id="5e694110-e833-4fc9-abe8-61a063d47ba6"
  data-base-api-url="https://ai.watsoncreative.com/api/embed"
  src="https://ai.watsoncreative.com/embed/anythingllm-chat-widget.min.js"
  data-button-color="#00b795"
  data-user-bg-color="#f5fcfb"
  data-assistant-bg-color="#f4f2f1"
  data-position="bottom-left"
  data-no-header="true"
  data-brand-image-url="https://cdn.prod.website-files.com/64c83832db063db353be392d/65a83d67a899b3f55c6982c0_watson-creative-mark-light-green.svg"
  data-chat-icon="chatBubble"
  data-position="bottom-right"
  data-text-size="16px"
  data-window-height="90%"
  data-window-width="90%"
  data-greeting="Got a big vision? Letâ€™s talk about how Watson Creative can bring it to life."
  data-show-thoughts="true"
  data-no-sponsor="true"
  data-sponsor-link="https://watsoncreative.com"
  data-sponsor-text="Powered by Watson Creative"
  data-username="website-visitor"
  data-support-email="hello@watsoncreative.com"
  data-assistant-name="Watson Creative Chat Assistant"
  data-assistant-icon="https://cdn.prod.website-files.com/64c83832db063db353be392d/65a83d67a899b3f55c6982c0_watson-creative-mark-light-green.svg"
></script>
<script>
// Chat bubble popup functionality
(function() {
    // ===== CONFIGURATION =====
    const CONFIG = {
        // Timing settings
        POPUP_DELAY: 2000,        		// Time to wait before showing first popup
        WIDGET_CHECK_INTERVAL: 500, 	// How often to check if widget loaded
        POPUP_APPEAR_DELAY: 50,     	// Delay before popup animation starts
        TYPING_START_DELAY: 300,    	// Delay before typing begins
        LETTER_TYPE_INTERVAL: 10,   	// Time between each letter
        AUTO_HIDE_DELAY: 10000,     	// Auto-hide after this time
        HIDE_ANIMATION_DURATION: 300, // Hide animation duration
        NEXT_POPUP_DELAY: 20000,     	// Time to wait before showing next popup
        // Popup behavior settings
        USE_COOKIE_LIMIT: false,				// Set to false to disable cookie tracking
        COOKIE_DAYS: 1,            		// How many days to remember popup was shown
        MAX_POPUPS_PER_SESSION: 8			// High number for continuous testing
    };

    // Array of popup messages
    const popupMessages = [
        "Looking for advice? We've got it.",
        "Got a brand challenge? Let's talk.",
        "Ready to break through the noise?",
        "What's your next big move?",
        "Strategy starts with a conversation.",
        "Tell us what's keeping you up at night.",
        "Every breakthrough starts with a question.",
        "What change are you trying to create?",
        "Ready to move beyond ordinary?",
        "Let's figure this out together.",
        "What's your brand's untold story?",
        "Skip the small talk. What's the real challenge?",
        "Ready for a different kind of agency conversation?",
        "What if your brand could do more?",
        "Let's cut through the clutter.",
        "Got 2 minutes to explore what's possible?",
        "Ready to turn curiosity into clarity?",
        "Let's talk about what matters.",
        "What's your vision? Let's make it real.",
        "Every transformation starts here."
    ];

    // Session counter for tracking popups shown this session
    let popupsShownThisSession = 0;
    let continuousMode = false;

    // Cookie management
    function setCookie(name, value, days) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
    }

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    // Check if we should show popup based on configuration
    function shouldShowPopup() {
        // Check session limit
        if (popupsShownThisSession >= CONFIG.MAX_POPUPS_PER_SESSION) {
            return false;
        }

        // Check cookie limit if enabled
        if (CONFIG.USE_COOKIE_LIMIT && getCookie('watson_chat_popup_shown')) {
            return false;
        }

        return true;
    }

    // Function to stop popups when chat button is clicked
    function stopPopups() {
        continuousMode = false;
        if (CONFIG.USE_COOKIE_LIMIT) {
            setCookie('watson_chat_popup_shown', 'true', CONFIG.COOKIE_DAYS);
        }
        // Hide any current popup
        const currentPopup = document.getElementById('watson-chat-popup');
        if (currentPopup) {
            hidePopup(currentPopup);
        }
    }

    // Function to trigger next popup in sequence
    function scheduleNextPopup() {
        setTimeout(() => {
            if (shouldShowPopup() && continuousMode) {
                showChatPopup();
                popupsShownThisSession++;
                
                // Set cookie if enabled
                if (CONFIG.USE_COOKIE_LIMIT) {
                    setCookie('watson_chat_popup_shown', 'true', CONFIG.COOKIE_DAYS);
                }
            }
        }, CONFIG.NEXT_POPUP_DELAY);
    }

    // Wait for chat widget to load, then start timer
    function waitForChatWidget() {
        const chatContainer = document.getElementById('anything-llm-embed-chat-button-container');
        if (chatContainer) {
            // Widget is loaded, start timer for first popup
            setTimeout(() => {
                if (shouldShowPopup()) {
                    continuousMode = true;
                    showChatPopup();
                    popupsShownThisSession++;
                    
                    // Set cookie if enabled
                    if (CONFIG.USE_COOKIE_LIMIT) {
                        setCookie('watson_chat_popup_shown', 'true', CONFIG.COOKIE_DAYS);
                    }
                }
            }, CONFIG.POPUP_DELAY);

            // Add click listener to chat button to stop popups
            const chatButton = document.getElementById('anything-llm-embed-chat-button');
            if (chatButton) {
                chatButton.addEventListener('click', stopPopups);
            } else {
                // If button not found immediately, check periodically
                const checkForButton = setInterval(() => {
                    const button = document.getElementById('anything-llm-embed-chat-button');
                    if (button) {
                        button.addEventListener('click', stopPopups);
                        clearInterval(checkForButton);
                    }
                }, CONFIG.WIDGET_CHECK_INTERVAL);
            }
        } else {
            // Widget not loaded yet, check again
            setTimeout(waitForChatWidget, CONFIG.WIDGET_CHECK_INTERVAL);
        }
    }

    // Start checking for widget on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForChatWidget);
    } else {
        waitForChatWidget();
    }

    function showChatPopup() {
        // Get random message
        const randomMessage = popupMessages[Math.floor(Math.random() * popupMessages.length)];
        
        // Find the chat button container
        const chatContainer = document.getElementById('anything-llm-embed-chat-button-container');
        if (!chatContainer) return;

        // Create popup bubble
        const popup = document.createElement('div');
        popup.id = 'watson-chat-popup';
        popup.style.cssText = `
            position: absolute;
            bottom: 40px;
            left: 40px;
            background-color: white;
            color: #333;
            padding: 12px 16px;
            border-radius: 18px 18px 18px 0px;
            box-shadow: 0 4px 12px rgba(0,0,0,0);
            width: auto;
            font-family: Barlow, sans-serif, -apple-system;
            font-size: 14px;
            line-height: 1.4;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            white-space: nowrap;
            overflow: visible;
            cursor: default !important;
        `;

        // Remove any potential conflicting styles/shadows and carrot
        popup.style.setProperty('box-shadow', '0 4px 12px rgba(0,0,0,0)', 'important');
        popup.style.setProperty('border', 'none', 'important');

        // Create text container
        const textContainer = document.createElement('div');
        textContainer.style.cssText = `
            position: relative;
            width: auto;
            display: inline-block;
            white-space: nowrap;
        `;
        popup.appendChild(textContainer);

        // Add popup to container
        chatContainer.appendChild(popup);

        // Remove any potential carrot/tail CSS
        const style = document.createElement('style');
        style.textContent = '#watson-chat-popup::before, #watson-chat-popup::after { display: none !important; }';
        document.head.appendChild(style);

        // Animate popup appearance
        setTimeout(() => {
            popup.style.opacity = '1';
            popup.style.transform = 'translateY(0) scale(1)';
            popup.style.pointerEvents = 'auto';
        }, CONFIG.POPUP_APPEAR_DELAY);

        // Start typing animation after popup appears
        setTimeout(() => {
            typeText(textContainer, randomMessage);
        }, CONFIG.TYPING_START_DELAY);

        // Auto-hide after delay
        setTimeout(() => {
            hidePopup(popup);
        }, CONFIG.AUTO_HIDE_DELAY);

        // Hide on click anywhere (but don't stop continuous mode unless it's the chat button)
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#anything-llm-embed-chat-button')) {
                hidePopup(popup);
            }
        }, { once: true });
    }

    function typeText(container, text) {
        const letters = text.split('');
        
        letters.forEach((letter, index) => {
            const span = document.createElement('span');
            span.textContent = letter;
            span.style.cssText = `
                opacity: 0;
                transform: translateY(-10px);
                transition: all 0.2s ease-out;
                display: inline-block;
                ${letter === ' ' ? 'width: 0.25em;' : ''}
            `;
            container.appendChild(span);

            // Animate each letter with delay
            setTimeout(() => {
                span.style.opacity = '1';
                span.style.transform = 'translateY(0)';
            }, index * CONFIG.LETTER_TYPE_INTERVAL);
        });
    }

    function hidePopup(popup) {
        if (popup && popup.parentNode) {
            popup.style.opacity = '0';
            popup.style.transform = 'translateY(10px) scale(0.95)';
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
                
                // Schedule next popup if in continuous mode
                if (continuousMode) {
                    scheduleNextPopup();
                }
            }, CONFIG.HIDE_ANIMATION_DURATION);
        }
    }
})();
</script>
<script>
// Add disclaimer to chatbot messages
(function() {
    // The disclaimer text to add
    const DISCLAIMER_TEXT = " - This chatbot is powered by AI. It's here to help, but it might not always get things right. For anything important, double-check with our team.";
    
    // Function to add disclaimer to timestamp
    function addDisclaimer(timestampElement) {
        // Check if disclaimer already added
        if (!timestampElement.textContent.includes(DISCLAIMER_TEXT)) {
            timestampElement.textContent += DISCLAIMER_TEXT;
        }
    }
    
    // Function to process all messages
    function processAllMessages() {
        // Find all timestamp divs that belong to assistant messages
        // They have text-left class and contain time pattern
        const allTimestamps = document.querySelectorAll('.allm-font-sans.allm-text-\\[10px\\].allm-text-gray-400.allm-text-left');
        
        allTimestamps.forEach(timestamp => {
            // Check if this is a valid timestamp
            if (timestamp.textContent.match(/^\d{1,2}:\d{2}\s*(AM|PM)$/)) {
                // Check if there's an assistant message above this timestamp
                const parentBlock = timestamp.closest('.allm-py-\\[5px\\]');
                if (parentBlock && parentBlock.querySelector('.allm-anything-llm-assistant-message')) {
                    addDisclaimer(timestamp);
                }
            }
        });
    }
    
    // Set up MutationObserver to watch for new messages
    const observer = new MutationObserver((mutations) => {
        // Process all messages whenever DOM changes
        processAllMessages();
    });
    
    // Start observing when chat widget loads
    function startObserving() {
        // Look for the chat history container
        const chatHistory = document.getElementById('chat-history');
        const chatContainer = document.getElementById('anything-llm-chat');
        const embedContainer = document.getElementById('anything-llm-embed-chat-container');
        
        const targetElement = chatHistory || chatContainer || embedContainer;
        
        if (targetElement) {
            observer.observe(targetElement, {
                childList: true,
                subtree: true,
                characterData: true
            });
            // Process any existing messages
            processAllMessages();
            console.log('Watson disclaimer script started monitoring chat messages');
        } else {
            // Try again if chat container not found
            setTimeout(startObserving, 500);
        }
    }
    
    // Also run periodically as a fallback
    setInterval(processAllMessages, 1000);
    
    // Start when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', startObserving);
    } else {
        startObserving();
    }
})();
</script>
<script>
// Form-based initial interaction for Watson Creative chatbot
(function() {
    let formSubmitted = false;
    let chatInitialized = false;

    // Function to create the intake form
    function createIntakeForm() {
        const formHTML = `
            <div id="watson-intake-form" class="allm-px-4 allm-py-4 allm-w-full">
                <form id="watson-contact-form" class="allm-flex allm-flex-col allm-gap-y-3" onsubmit="return false;">
                    <div class="allm-flex allm-gap-x-2">
                        <input type="text" id="first-name" name="firstName" placeholder="First Name" required
                            class="allm-flex-1 allm-px-3 allm-py-2 allm-border allm-border-gray-300 allm-rounded-lg allm-text-sm allm-bg-white focus:allm-outline-none focus:allm-border-[#00b795]">
                        <input type="text" id="last-name" name="lastName" placeholder="Last Name" required
                            class="allm-flex-1 allm-px-3 allm-py-2 allm-border allm-border-gray-300 allm-rounded-lg allm-text-sm allm-bg-white focus:allm-outline-none focus:allm-border-[#00b795]">
                    </div>
                    <input type="email" id="email" name="email" placeholder="Email" required
                        class="allm-w-full allm-px-3 allm-py-2 allm-border allm-border-gray-300 allm-rounded-lg allm-text-sm allm-bg-white focus:allm-outline-none focus:allm-border-[#00b795]">
                    <input type="tel" id="phone" name="phone" placeholder="Phone"
                        class="allm-w-full allm-px-3 allm-py-2 allm-border allm-border-gray-300 allm-rounded-lg allm-text-sm allm-bg-white focus:allm-outline-none focus:allm-border-[#00b795]">
                    <input type="text" id="company" name="company" placeholder="Company"
                        class="allm-w-full allm-px-3 allm-py-2 allm-border allm-border-gray-300 allm-rounded-lg allm-text-sm allm-bg-white focus:allm-outline-none focus:allm-border-[#00b795]">
                    <textarea id="message" name="message" placeholder="Tell us about your project..." required
                        rows="3"
                        class="allm-w-full allm-px-3 allm-py-2 allm-border allm-border-gray-300 allm-rounded-lg allm-text-sm allm-bg-white focus:allm-outline-none focus:allm-border-[#00b795] allm-resize-none"></textarea>
                    <button type="submit" 
                        class="allm-w-full allm-py-2 allm-px-4 allm-bg-[#00b795] allm-text-white allm-rounded-lg allm-font-medium allm-text-sm hover:allm-bg-[#00a084] allm-transition-colors">
                        Start Conversation
                    </button>
                </form>
            </div>
        `;
        return formHTML;
    }

    // Function to hide the message input area and show the form
    function showIntakeForm() {
        // Find the chat container
        const chatContainer = document.getElementById('anything-llm-chat');
        if (!chatContainer || formSubmitted) return;

        console.log('Watson Chat: Showing intake form');

        // Hide the original message input form
        const originalForm = chatContainer.querySelector('form');
        if (originalForm) {
            originalForm.style.display = 'none';
            console.log('Watson Chat: Original form hidden');
        }

        // Check if form already exists
        let intakeForm = document.getElementById('watson-intake-form');
        
        if (!intakeForm) {
            // Find the greeting text container
            const greetingContainer = chatContainer.querySelector('.allm-text-slate-400.allm-text-sm.allm-font-sans.allm-py-4.allm-text-center')?.parentElement?.parentElement;
            
            if (greetingContainer) {
                // Insert the form after the greeting
                const formDiv = document.createElement('div');
                formDiv.innerHTML = createIntakeForm();
                greetingContainer.appendChild(formDiv.firstElementChild);
                intakeForm = document.getElementById('watson-intake-form');
                console.log('Watson Chat: Intake form created');
            }
        }
        
        // Show the intake form
        if (intakeForm) {
            intakeForm.style.display = 'block';
            console.log('Watson Chat: Intake form container displayed');
            
            // Make sure the actual form is visible too
            const form = document.getElementById('watson-contact-form');
            if (form) {
                form.style.display = '';
                console.log('Watson Chat: Form element made visible');
                
                // Add form submission handler if not already added
                if (!form.hasAttribute('data-listener-added')) {
                    form.addEventListener('submit', handleFormSubmit, false);
                    form.setAttribute('data-listener-added', 'true');
                    console.log('Watson Chat: Form submission handler added');
                    
                    // Also add click handler to the submit button as backup
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            handleFormSubmit(e);
                        }, false);
                        console.log('Watson Chat: Button click handler added');
                    }
                }
            }
        }
    }

    // Function to handle form submission
    function handleFormSubmit(e) {
        if (e && e.preventDefault) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        console.log('Watson Chat: Form submitted');
        
        // Get the form element
        const form = document.getElementById('watson-contact-form');
        if (!form) {
            console.error('Watson Chat: Form not found');
            return false;
        }
        
        const formData = new FormData(form);
        const firstName = formData.get('firstName') || '';
        const lastName = formData.get('lastName') || '';
        const email = formData.get('email') || '';
        const phone = formData.get('phone') || '';
        const company = formData.get('company') || '';
        const message = formData.get('message') || '';

        console.log('Watson Chat: Form data collected:', {
            firstName, lastName, email, phone, company, message
        });

        // Format the message according to the specified format
        const formattedMessage = `<first_name>${firstName}</first_name>|<last_name>${lastName}</last_name>|<email>${email}</email>|<phone>${phone}</phone>|<company>${company}</company>|<message>${message}</message>`;
        console.log('Watson Chat: Formatted message:', formattedMessage);

        // First, show the original message input (it needs to be visible to work)
        const originalForm = document.querySelector('#anything-llm-chat form:not(#watson-contact-form)');
        if (originalForm) {
            originalForm.style.display = '';
            console.log('Watson Chat: Original form shown');
        }

        // Hide the intake form
        const intakeForm = document.getElementById('watson-intake-form');
        if (intakeForm) {
            intakeForm.style.display = 'none';
            console.log('Watson Chat: Intake form hidden');
        }

        // Send the message with a slight delay to ensure DOM is ready
        setTimeout(() => {
            console.log('Watson Chat: Waiting for message input to be available');
            let attempts = 0;
            
            // Wait for the input to be available
            const waitForInput = setInterval(() => {
                attempts++;
                const messageInput = document.getElementById('message-input');
                const sendButton = document.getElementById('send-message-button');
                
                console.log(`Watson Chat: Attempt ${attempts} - Input found: ${!!messageInput}, Button found: ${!!sendButton}, Input visible: ${messageInput ? messageInput.offsetParent !== null : false}`);
                
                if (messageInput && sendButton && messageInput.offsetParent !== null) {
                    clearInterval(waitForInput);
                    console.log('Watson Chat: Input and button are ready, sending message');
                    sendFormattedMessage(formattedMessage);
                    
                    // Mark form as submitted after sending
                    formSubmitted = true;
                    
                    // Store form submission state
                    sessionStorage.setItem('watson_form_submitted', 'true');
                }
            }, 100);
            
            // Timeout after 5 seconds
            setTimeout(() => {
                clearInterval(waitForInput);
                console.error('Watson Chat: Timeout waiting for message input');
            }, 5000);
        }, 200);
        
        // Prevent default form submission
        return false;
    }

    // Function to send the formatted message
    function sendFormattedMessage(message) {
        console.log('Watson Chat: Attempting to send message:', message);
        
        // Find the message input and send button
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-message-button');

        console.log('Watson Chat: Message input found:', !!messageInput);
        console.log('Watson Chat: Send button found:', !!sendButton);

        if (messageInput && sendButton) {
            // Focus the input first
            messageInput.focus();
            
            // For React controlled components, we need to simulate native input
            const nativeInputValueSetter = Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype, 'value').set;
            nativeInputValueSetter.call(messageInput, message);
            
            // Create and dispatch input event for React
            const inputEvent = new Event('input', { bubbles: true });
            messageInput.dispatchEvent(inputEvent);
            
            console.log('Watson Chat: Message set in input:', messageInput.value);
            
            // Try multiple approaches to submit
            setTimeout(() => {
                // Method 1: Submit the form directly
                const form = messageInput.closest('form');
                if (form) {
                    console.log('Watson Chat: Submitting form directly');
                    // Create and dispatch a submit event
                    const submitEvent = new Event('submit', { 
                        bubbles: true, 
                        cancelable: true 
                    });
                    
                    // Prevent default to let React handle it
                    form.addEventListener('submit', function(e) {
                        console.log('Watson Chat: Form submit event triggered');
                    }, { once: true });
                    
                    form.dispatchEvent(submitEvent);
                }
                
                // Method 2: Click the button with proper event
                setTimeout(() => {
                    if (messageInput.value === message) {
                        console.log('Watson Chat: Trying button click');
                        const clickEvent = new MouseEvent('click', {
                            view: window,
                            bubbles: true,
                            cancelable: true
                        });
                        sendButton.dispatchEvent(clickEvent);
                    }
                }, 100);
                
                // Method 3: Trigger Enter key press
                setTimeout(() => {
                    if (messageInput.value === message) {
                        console.log('Watson Chat: Trying Enter key press');
                        const enterEvent = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true,
                            cancelable: true
                        });
                        messageInput.dispatchEvent(enterEvent);
                        
                        // Also try keypress
                        const keypressEvent = new KeyboardEvent('keypress', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true,
                            cancelable: true
                        });
                        messageInput.dispatchEvent(keypressEvent);
                    }
                }, 200);
                
                // Check if message was sent after all attempts
                setTimeout(() => {
                    if (messageInput.value === '') {
                        console.log('Watson Chat: Message sent successfully');
                    } else {
                        console.log('Watson Chat: Message may not have been sent, value still in input');
                    }
                }, 500);
            }, 100);
        } else {
            console.error('Watson Chat: Could not find message input or send button');
        }
    }

    // Function to check if form was already submitted this session
    function checkFormStatus() {
        return sessionStorage.getItem('watson_form_submitted') === 'true';
    }

    // Initialize the form when chat opens
    function initializeFormInteraction() {
        // Prevent duplicate initialization
        if (chatInitialized) {
            console.log('Watson Chat: Already initialized, skipping');
            return;
        }
        
        console.log('Watson Chat: Initializing form interaction');
        chatInitialized = true;
        
        // Always check current form status
        formSubmitted = checkFormStatus();
        console.log('Watson Chat: Form submitted status:', formSubmitted);
        
        // Show form if not submitted
        if (!formSubmitted) {
            // Wait a bit for the chat to fully render
            setTimeout(() => {
                showIntakeForm();
                
                // Also ensure the original form is hidden
                const originalForm = document.querySelector('#anything-llm-chat form:not(#watson-contact-form)');
                if (originalForm) {
                    originalForm.style.display = 'none';
                }
            }, 500);
        } else {
            // If form was submitted, ensure regular chat input is visible
            const originalForm = document.querySelector('#anything-llm-chat form:not(#watson-contact-form)');
            if (originalForm) {
                originalForm.style.display = '';
            }
        }
    }

    // Watch for chat window to open
    function watchForChatOpen() {
        console.log('Watson Chat: Starting to watch for chat window');
        
        const observer = new MutationObserver((mutations) => {
            // Check if chat window is visible
            const chatWindow = document.getElementById('anything-llm-chat');
            if (chatWindow) {
                // Check if it's visible (not display: none and has dimensions)
                const isVisible = chatWindow.offsetParent !== null || 
                                window.getComputedStyle(chatWindow).display !== 'none';
                
                if (isVisible && !chatInitialized) {
                    console.log('Watson Chat: Chat window detected as open');
                    initializeFormInteraction();
                }
            }
        });

        // Start observing
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });

        // Also check if chat is already open
        setTimeout(() => {
            const chatWindow = document.getElementById('anything-llm-chat');
            if (chatWindow) {
                const isVisible = chatWindow.offsetParent !== null || 
                                window.getComputedStyle(chatWindow).display !== 'none';
                if (isVisible) {
                    console.log('Watson Chat: Chat window already open');
                    initializeFormInteraction();
                }
            }
        }, 1000);
    }

    // Start watching when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', watchForChatOpen);
    } else {
        watchForChatOpen();
    }

    // Watch for reset button clicks
    function watchForResetButton() {
        const observer = new MutationObserver((mutations) => {
            // Look for the reset button - it has specific classes and text
            const buttons = document.querySelectorAll('button.allm-h-fit.allm-px-0.hover\\:allm-cursor-pointer.allm-border-none.allm-text-sm.allm-bg-transparent');
            buttons.forEach(button => {
                if (button.textContent.trim() === 'Reset Chat') {
                    // Remove existing listener to avoid duplicates
                    button.removeEventListener('click', handleResetClick);
                    // Add click listener
                    button.addEventListener('click', handleResetClick);
                }
            });
        });

        // Start observing
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Also check immediately in case button already exists
        const buttons = document.querySelectorAll('button.allm-h-fit.allm-px-0.hover\\:allm-cursor-pointer.allm-border-none.allm-text-sm.allm-bg-transparent');
        buttons.forEach(button => {
            if (button.textContent.trim() === 'Reset Chat') {
                button.addEventListener('click', handleResetClick);
            }
        });
    }

    // Handle reset button click
    function handleResetClick() {
        console.log('Watson Chat: Reset button clicked, clearing form state');
        // Clear the form submission state
        sessionStorage.removeItem('watson_form_submitted');
        // Reset our flags
        formSubmitted = false;
        chatInitialized = false;
        
        // Wait a bit for the chat to reset, then re-initialize
        setTimeout(() => {
            // Check if chat is open and re-initialize
            const chatWindow = document.getElementById('anything-llm-chat');
            if (chatWindow && chatWindow.style.display !== 'none') {
                initializeFormInteraction();
            }
        }, 500);
    }

    // Start watching for reset button
    watchForResetButton();
    
    // Function to watch for and modify form submission messages
    function watchForFormMessages() {
        const observer = new MutationObserver((mutations) => {
            // Look for user messages that contain our form data
            const userMessages = document.querySelectorAll('.allm-anything-llm-user-message p');
            
            userMessages.forEach(p => {
                const text = p.textContent;
                // Check if this is a form submission message
                if (text.includes('<first_name>') && text.includes('<message>') && !p.classList.contains('watson-processed')) {
                    // Extract the message content
                    const messageMatch = text.match(/<message>(.*?)<\/message>/);
                    if (messageMatch) {
                        const messageContent = messageMatch[1];
                        
                        // Add class to identify this message
                        p.classList.add('watson-form-submission-message', 'watson-processed');
                        
                        // Create a span for the visible message
                        const visibleSpan = document.createElement('span');
                        visibleSpan.className = 'watson-visible-message';
                        visibleSpan.textContent = messageContent;
                        
                        // Clear the paragraph and add only the visible message
                        p.innerHTML = '';
                        p.appendChild(visibleSpan);
                        
                        console.log('Watson Chat: Form message display updated');
                    }
                }
            });
        });
        
        // Start observing the chat container
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            characterData: true
        });
    }
    
    // Start watching for form messages
    watchForFormMessages();

    // Expose functions for debugging
    window.watsonChatDebug = {
        showForm: showIntakeForm,
        resetForm: () => {
            sessionStorage.removeItem('watson_form_submitted');
            formSubmitted = false;
            chatInitialized = false;
            console.log('Watson Chat: Form state reset');
            showIntakeForm();
        },
        checkStatus: () => {
            const intakeForm = document.getElementById('watson-intake-form');
            const contactForm = document.getElementById('watson-contact-form');
            const originalForm = document.querySelector('#anything-llm-chat form:not(#watson-contact-form)');
            
            console.log('Watson Chat Status:', {
                formSubmitted,
                chatInitialized,
                sessionStorage: sessionStorage.getItem('watson_form_submitted'),
                intakeFormExists: !!intakeForm,
                intakeFormVisible: intakeForm?.style.display,
                contactFormExists: !!contactForm,
                contactFormVisible: contactForm?.style.display,
                originalFormVisible: originalForm?.style.display,
                messageInputExists: !!document.getElementById('message-input'),
                sendButtonExists: !!document.getElementById('send-message-button')
            });
        }
    };

    // Add custom styles for the form
    const style = document.createElement('style');
    style.textContent = `
        #watson-intake-form {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #watson-contact-form input:focus,
        #watson-contact-form textarea:focus {
            border-color: #00b795 !important;
            box-shadow: 0 0 0 3px rgba(0, 183, 149, 0.1);
        }
        
        #watson-contact-form button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 183, 149, 0.3);
        }
        
        #watson-contact-form button:active {
            transform: translateY(0);
        }
        
        /* Style to hide the form data in the first user message */
        .watson-form-submission-message {
            font-size: 0 !important;
            line-height: 0 !important;
        }
        
        .watson-form-submission-message .watson-visible-message {
            font-size: 16px !important;
            line-height: 20px !important;
            display: inline-block;
        }
    `;
    document.head.appendChild(style);
})();
</script>
</body>
<!-- END CHAT BOT CODE -->
</html>